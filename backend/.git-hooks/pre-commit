#!/bin/bash

# ClipCook Backend Pre-Commit Hook
# Runs quality checks before allowing commits

set -e  # Exit on any error

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Change to backend directory
cd "$(dirname "$0")/../.." || exit 1

# 1. Check for direct commits to main/master
BRANCH=$(git symbolic-ref HEAD 2>/dev/null | sed 's/refs\/heads\///')
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
    echo -e "${RED}‚ùå Direct commits to $BRANCH are not allowed!${NC}"
    echo -e "${YELLOW}Please create a feature branch:${NC}"
    echo "  git checkout -b feature/your-feature-name"
    exit 1
fi

# 2. TypeScript Build Check
echo "üì¶ Building TypeScript..."
if ! npm run build > /dev/null 2>&1; then
    echo -e "${RED}‚ùå TypeScript build failed!${NC}"
    echo "Run 'npm run build' to see errors"
    exit 1
fi
echo -e "${GREEN}‚úì TypeScript build successful${NC}"

# 3. Check for environment variable usage without validation
echo "üîê Checking environment variable usage..."
UNVALIDATED_VARS=$(git diff --cached --name-only | grep '\.ts$' | xargs -I {} sh -c 'grep -n "process\.env\." {} || true' | grep -v "envValidator" || true)
if [ -n "$UNVALIDATED_VARS" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: New environment variables detected${NC}"
    echo "$UNVALIDATED_VARS"
    echo -e "${YELLOW}Ensure they're added to envValidator.ts${NC}"
fi

# 4. Check for hardcoded secrets or API keys
echo "üîí Checking for hardcoded secrets..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -n "$STAGED_FILES" ]; then
    # Check TypeScript/JavaScript files for assignment-style secrets
    TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|js)$' || true)
    if [ -n "$TS_FILES" ]; then
        if echo "$TS_FILES" | xargs grep -i -E "(api[_-]?key|secret[_-]?key|password|token)[[:space:]]*=[[:space:]]*['\"][^'\"]{20,}" 2>/dev/null; then
            echo -e "${RED}‚ùå Potential hardcoded secret detected!${NC}"
            echo -e "${YELLOW}Use environment variables instead${NC}"
            exit 1
        fi
    fi

    # Check JSON files for secret patterns (this would have caught railway-env.json)
    JSON_FILES=$(echo "$STAGED_FILES" | grep -E '\.json$' || true)
    if [ -n "$JSON_FILES" ]; then
        # Check for keys in JSON format: "KEY_NAME": "value"
        if echo "$JSON_FILES" | xargs grep -E "\"[A-Z_]*(KEY|SECRET|PASSWORD|TOKEN)[A-Z_]*\"[[:space:]]*:[[:space:]]*\"[^\"]{20,}\"" 2>/dev/null; then
            echo -e "${RED}‚ùå Potential secret in JSON format detected!${NC}"
            echo -e "${YELLOW}Never commit secrets in JSON files${NC}"
            exit 1
        fi
    fi

    # Check .env files (should never be committed)
    ENV_FILES=$(echo "$STAGED_FILES" | grep -E '\.env$|\.env\.' || true)
    if [ -n "$ENV_FILES" ]; then
        echo -e "${RED}‚ùå .env file detected in commit!${NC}"
        echo -e "${YELLOW}Files: ${ENV_FILES}${NC}"
        echo -e "${YELLOW}.env files should never be committed. Add to .gitignore${NC}"
        exit 1
    fi

    # Check for common API key patterns (any file type)
    if echo "$STAGED_FILES" | xargs grep -E "(sk-[A-Za-z0-9]{40,}|AIza[A-Za-z0-9]{35}|sb_secret_[A-Za-z0-9_-]{20,})" 2>/dev/null; then
        echo -e "${RED}‚ùå API key pattern detected!${NC}"
        echo -e "${YELLOW}Detected patterns: OpenAI (sk-), Google (AIza), or Supabase (sb_secret_)${NC}"
        echo -e "${YELLOW}Never commit API keys${NC}"
        exit 1
    fi
fi
echo -e "${GREEN}‚úì No hardcoded secrets detected${NC}"

# 5. Check for console.log statements (should use logger instead)
echo "üìù Checking for console.log usage..."
if [ -n "$STAGED_FILES" ]; then
    CONSOLE_LOGS=$(echo "$STAGED_FILES" | xargs grep -n "console\.log" 2>/dev/null || true)
    if [ -n "$CONSOLE_LOGS" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Warning: console.log detected (use logger instead):${NC}"
        echo "$CONSOLE_LOGS"
        echo -e "${YELLOW}Replace with: import logger from './utils/logger'${NC}"
    fi
fi

# 6. Run linter if available
if npm run lint:check > /dev/null 2>&1; then
    echo "üé® Running linter..."
    if ! npm run lint:check; then
        echo -e "${YELLOW}‚ö†Ô∏è  Linting warnings detected${NC}"
        echo "Run 'npm run lint' to see details"
    else
        echo -e "${GREEN}‚úì Linting passed${NC}"
    fi
fi

# 7. Run unit tests
echo "üß™ Running tests..."
if npm run test:unit > /dev/null 2>&1; then
    echo -e "${GREEN}‚úì All tests passed${NC}"
else
    echo -e "${RED}‚ùå Tests failed!${NC}"
    echo "Run 'npm run test:unit' to see failures"
    exit 1
fi

# 8. Check for TODO comments in staged files
if [ -n "$STAGED_FILES" ]; then
    TODOS=$(echo "$STAGED_FILES" | xargs grep -n "// TODO\|// FIXME\|// HACK" 2>/dev/null || true)
    if [ -n "$TODOS" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  TODOs/FIXMEs found in staged files:${NC}"
        echo "$TODOS"
        echo -e "${YELLOW}Consider creating GitHub issues for these${NC}"
    fi
fi

# 9. Check for large files
echo "üìè Checking file sizes..."
LARGE_FILES=$(git diff --cached --name-only | xargs ls -lh 2>/dev/null | awk '{if ($5 ~ /M$/ && $5+0 > 1) print $9 " (" $5 ")"}' || true)
if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: Large files detected:${NC}"
    echo "$LARGE_FILES"
    echo -e "${YELLOW}Consider if these should be committed${NC}"
fi

# 10. Success message
echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
echo ""

exit 0
